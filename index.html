<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø´Ø§Ø´Ø§Øª Ø³Ø¨Ø£ (Supabase)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { background-color: #ecf0f1; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .main-card { max-width: 900px; margin: 40px auto; box-shadow: 0 4px 20px rgba(0,0,0,0.1); border: none; border-radius: 20px; overflow: hidden; }
        .header { background: linear-gradient(135deg, #3ecf8e, #27ae60); color: white; padding: 30px; text-align: center; } /* Ù„ÙˆÙ† Supabase Ø§Ù„Ø£Ø®Ø¶Ø± */
        .btn-primary-custom { background-color: #27ae60; color: white; border: none; padding: 10px 20px; border-radius: 10px; }
        .btn-primary-custom:hover { background-color: #219150; color: white; }
        .preview-img { width: 80px; height: 50px; object-fit: cover; border-radius: 8px; border: 1px solid #ddd; }
    </style>
</head>
<body>

<div class="card main-card">
    <div class="header">
        <h1>âš¡ Ù†Ø¸Ø§Ù… Ø´Ø§Ø´Ø§Øª Ø³Ø¨Ø£ (SQL)</h1>
        <p class="mb-0">Powered by Supabase</p>
    </div>
    
    <div class="card-body p-4">
        
        <ul class="nav nav-tabs mb-4" id="myTab" role="tablist">
            <li class="nav-item">
                <button class="nav-link active text-success" id="upload-tab" data-bs-toggle="tab" data-bs-target="#upload-pane">ğŸ“¤ Ø±ÙØ¹ Ù…Ù„Ù</button>
            </li>
            <li class="nav-item">
                <button class="nav-link text-success" id="link-tab" data-bs-toggle="tab" data-bs-target="#link-pane">ğŸ”— Ø±Ø§Ø¨Ø· Ø®Ø§Ø±Ø¬ÙŠ</button>
            </li>
        </ul>

        <div class="tab-content mb-5">
            <div class="tab-pane fade show active" id="upload-pane">
                <div class="row g-3 align-items-end">
                    <div class="col-md-7">
                        <label class="form-label">Ø§Ø®ØªØ± ØµÙˆØ±Ø© Ø£Ùˆ ÙÙŠØ¯ÙŠÙˆ:</label>
                        <input type="file" id="fileInput" class="form-control" accept="image/*,video/*">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Ø§Ù„Ù…Ø¯Ø© (Ù…Ù„Ù„ÙŠ Ø«Ø§Ù†ÙŠØ©):</label>
                        <input type="number" id="durationUpload" class="form-control" value="5000">
                    </div>
                    <div class="col-md-2">
                        <button onclick="uploadFile()" class="btn btn-primary-custom w-100" id="btnUpload">Ø±ÙØ¹ ğŸš€</button>
                    </div>
                </div>
                <div id="uploadStatus" class="mt-2 text-center text-success fw-bold" style="display:none;"></div>
            </div>

            <div class="tab-pane fade" id="link-pane">
                <div class="row g-3 align-items-end">
                    <div class="col-md-7">
                        <label class="form-label">Ø±Ø§Ø¨Ø· Ù…Ø¨Ø§Ø´Ø±:</label>
                        <input type="text" id="urlInput" class="form-control" placeholder="https://example.com/image.jpg">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Ø§Ù„Ù…Ø¯Ø©:</label>
                        <input type="number" id="durationLink" class="form-control" value="5000">
                    </div>
                    <div class="col-md-2">
                        <button onclick="addLink()" class="btn btn-primary-custom w-100">Ø¥Ø¶Ø§ÙØ© ğŸ’¾</button>
                    </div>
                </div>
            </div>
        </div>

        <hr>

        <h5 class="mb-3 text-secondary">ğŸ“‹ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø­Ø§Ù„ÙŠ (Live)</h5>
        <div class="table-responsive">
            <table class="table table-hover align-middle">
                <thead class="table-light">
                    <tr>
                        <th>Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©</th>
                        <th>Ø§Ù„Ù†ÙˆØ¹</th>
                        <th>Ø§Ù„Ù…Ø¯Ø©</th>
                        <th>ØªØ­ÙƒÙ…</th>
                    </tr>
                </thead>
                <tbody id="playlistTable"></tbody>
            </table>
            <p id="emptyMsg" class="text-center text-muted">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</p>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // ğŸ”´ğŸ”´ Ù‡Ø§Ù… Ø¬Ø¯Ø§Ù‹: Ø¶Ø¹ Ù…ÙØ§ØªÙŠØ­ Supabase Ù‡Ù†Ø§ ğŸ”´ğŸ”´
    const SUPABASE_URL = 'https://kyixbictachrbyhhxmyj.supabase.co'; // Ù…Ø«Ø§Ù„: https://xyz.supabase.co
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt5aXhiaWN0YWNocmJ5aGh4bXlqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkxNjQwNTMsImV4cCI6MjA4NDc0MDA1M30.YNI2WonNj3W5WOJatOjvmEpx87KZrghTwg3oYHx_TpY'; // Anon Public Key

    // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø§ØªØµØ§Ù„
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // --- 1. Ø¯Ø§Ù„Ø© Ø§Ù„Ø±ÙØ¹ ---
    async function uploadFile() {
        const fileInput = document.getElementById('fileInput');
        const duration = document.getElementById('durationUpload').value;
        const file = fileInput.files[0];
        const btn = document.getElementById('btnUpload');
        const status = document.getElementById('uploadStatus');

        if (!file) { alert("Ø§Ø®ØªØ± Ù…Ù„ÙØ§Ù‹ Ø£ÙˆÙ„Ø§Ù‹!"); return; }

        btn.disabled = true;
        btn.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹...";
        status.style.display = 'block';
        status.innerText = "ÙŠØªÙ… Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù Ù„Ù„Ø³Ø­Ø§Ø¨Ø©... â˜ï¸";

        try {
            // Ø§Ø³Ù… Ù…Ù„Ù ÙØ±ÙŠØ¯
            const fileName = Date.now() + '_' + file.name.replace(/[^a-zA-Z0-9.]/g, '');
            
            // 1. Ø§Ù„Ø±ÙØ¹ Ù„Ù„ØªØ®Ø²ÙŠÙ†
            const { data, error } = await supabase.storage.from('uploads').upload(fileName, file);
            
            if (error) throw error;

            // 2. Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø¹Ø§Ù…
            const { data: { publicUrl } } = supabase.storage.from('uploads').getDownloadUrl(fileName); // ÙÙŠ Ø¨Ø¹Ø¶ Ø§Ù„Ù†Ø³Ø® getPublicUrl

            // 3. ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù†ÙˆØ¹
            const type = file.type.startsWith('video') ? 'video' : 'image';

            // 4. Ø§Ù„Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„
            await insertToDB(publicUrl, type, duration);

            status.innerText = "âœ… ØªÙ… Ø§Ù„Ø±ÙØ¹ Ø¨Ù†Ø¬Ø§Ø­!";
            fileInput.value = '';
            setTimeout(() => status.style.display = 'none', 3000);

        } catch (err) {
            alert("Ø®Ø·Ø£: " + err.message);
            status.innerText = "âŒ ÙØ´Ù„ Ø§Ù„Ø±ÙØ¹";
        } finally {
            btn.disabled = false;
            btn.innerText = "Ø±ÙØ¹ ğŸš€";
        }
    }

    // --- 2. Ø¥Ø¶Ø§ÙØ© Ø±Ø§Ø¨Ø· Ø®Ø§Ø±Ø¬ÙŠ ---
    async function addLink() {
        const url = document.getElementById('urlInput').value;
        const duration = document.getElementById('durationLink').value;
        if(!url) return;

        // ØªØ®Ù…ÙŠÙ† Ø§Ù„Ù†ÙˆØ¹ Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø·
        const type = (url.includes('.mp4') || url.includes('video')) ? 'video' : 'image';
        
        await insertToDB(url, type, duration);
        document.getElementById('urlInput').value = '';
        alert("ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©");
    }

    // --- Ø¯Ø§Ù„Ø© Ø§Ù„Ø­ÙØ¸ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ---
    async function insertToDB(url, type, duration) {
        const { error } = await supabase.from('playlist').insert([
            { media_url: url, media_type: type, duration: parseInt(duration) }
        ]);
        if (error) alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø©: " + error.message);
    }

    // --- 3. Ø¯Ø§Ù„Ø© Ø§Ù„Ø­Ø°Ù ---
    async function deleteItem(id) {
        if(!confirm("Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù†ØµØ±ØŸ")) return;
        const { error } = await supabase.from('playlist').delete().eq('id', id);
        if (error) alert("Ø®Ø·Ø£: " + error.message);
    }

    // --- 4. Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ¹Ø±Ø¶Ù‡Ø§ (Realtime) ---
    function renderTable(data) {
        const tbody = document.getElementById('playlistTable');
        const emptyMsg = document.getElementById('emptyMsg');
        tbody.innerHTML = '';

        if (data && data.length > 0) {
            emptyMsg.style.display = 'none';
            data.forEach(item => {
                const isVideo = item.media_type === 'video';
                const row = `
                    <tr>
                        <td>
                            ${isVideo ? 'ğŸ¬ ÙÙŠØ¯ÙŠÙˆ' : `<a href="${item.media_url}" target="_blank"><img src="${item.media_url}" class="preview-img"></a>`}
                        </td>
                        <td>${item.media_type}</td>
                        <td>${item.duration}</td>
                        <td><button onclick="deleteItem(${item.id})" class="btn btn-sm btn-outline-danger">Ø­Ø°Ù</button></td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        } else {
            emptyMsg.style.display = 'block';
            emptyMsg.innerText = "Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙØ§Ø±ØºØ©";
        }
    }

    // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„ØªØºÙŠÙŠØ±Ø§Øª (Live)
    async function fetchAndSubscribe() {
        // Ø¬Ù„Ø¨ Ù…Ø¨Ø¯Ø¦ÙŠ
        const { data } = await supabase.from('playlist').select('*').order('id', { ascending: false });
        renderTable(data);

        // Ø§Ø´ØªØ±Ø§Ùƒ ÙÙŠ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
        supabase.channel('custom-all-channel')
            .on(
                'postgres_changes',
                { event: '*', schema: 'public', table: 'playlist' },
                (payload) => {
                    // Ø¹Ù†Ø¯ Ø­Ø¯ÙˆØ« Ø£ÙŠ ØªØºÙŠÙŠØ±ØŒ Ù†Ø¹ÙŠØ¯ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                    supabase.from('playlist').select('*').order('id', { ascending: false })
                        .then(({ data }) => renderTable(data));
                }
            )
            .subscribe();
    }

    fetchAndSubscribe();

</script>
</body>
</html>