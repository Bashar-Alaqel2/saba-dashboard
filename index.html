<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø´Ø§Ø´Ø§Øª Ø³Ø¨Ø£ (Supabase)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { background-color: #f8f9fa; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .main-card { max-width: 800px; margin: 50px auto; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border: none; border-radius: 15px; }
        .header { background-color: #27ae60; color: white; padding: 20px; border-radius: 15px 15px 0 0; text-align: center; }
        .btn-add { background-color: #27ae60; color: white; }
        .btn-add:hover { background-color: #219150; color: white; }
        .preview-img { width: 60px; height: 40px; object-fit: cover; border-radius: 5px; }
    </style>
</head>
<body>

<div class="card main-card">
    <div class="header">
        <h2>âš¡ Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø´Ø§Ø´Ø§Øª (Supabase)</h2>
        <p>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶ Ù„Ø­Ø¸ÙŠØ§Ù‹</p>
    </div>
    <div class="card-body p-4">
        
        <ul class="nav nav-tabs mb-3">
            <li class="nav-item"><button class="nav-link active text-success" data-bs-toggle="tab" data-bs-target="#link-pane">ğŸ”— Ø±Ø§Ø¨Ø· Ø®Ø§Ø±Ø¬ÙŠ</button></li>
            <li class="nav-item"><button class="nav-link text-success" data-bs-toggle="tab" data-bs-target="#upload-pane">ğŸ“¤ Ø±ÙØ¹ Ù…Ù„Ù</button></li>
        </ul>

        <div class="tab-content">
            <div class="tab-pane fade show active" id="link-pane">
                <div class="row g-3">
                    <div class="col-md-8">
                        <input type="text" id="mediaUrl" class="form-control" placeholder="Ø±Ø§Ø¨Ø· Ù…Ø¨Ø§Ø´Ø± (URL)...">
                    </div>
                    <div class="col-md-4">
                        <input type="number" id="duration" class="form-control" value="5000">
                    </div>
                    <div class="col-12">
                        <button onclick="addLink()" class="btn btn-add w-100">Ø¥Ø±Ø³Ø§Ù„ ğŸš€</button>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="upload-pane">
                <div class="row g-3">
                    <div class="col-md-12">
                        <input type="file" id="fileInput" class="form-control" accept="image/*,video/*">
                    </div>
                    <div class="col-12">
                        <button onclick="uploadFile()" class="btn btn-add w-100" id="btnUpload">Ø±ÙØ¹ ÙˆØ¥Ø±Ø³Ø§Ù„ ğŸ“¤</button>
                    </div>
                    <div id="uploadStatus" class="text-center text-success mt-2" style="display:none"></div>
                </div>
            </div>
        </div>

        <hr class="my-5">

        <h5 class="mb-3">ğŸ“‹ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø­Ø§Ù„ÙŠ</h5>
        <div class="table-responsive">
            <table class="table table-hover align-middle">
                <thead class="table-light">
                    <tr><th>Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„Ù…Ø¯Ø©</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr>
                </thead>
                <tbody id="playlistTable"></tbody>
            </table>
            <p id="emptyMsg" class="text-center text-muted">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...</p>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // ğŸ”´ğŸ”´ Ø¶Ø¹ Ù…ÙØ§ØªÙŠØ­ Supabase Ù‡Ù†Ø§ (Ø§Ù„ØªÙŠ Ù†Ø³Ø®ØªÙ‡Ø§ Ø³Ø§Ø¨Ù‚Ø§Ù‹) ğŸ”´ğŸ”´
    const SUPABASE_URL = 'YOUR_SUPABASE_URL';
    const SUPABASE_KEY = 'YOUR_SUPABASE_ANON_KEY';

    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // --- 1. Ø¥Ø¶Ø§ÙØ© Ø±Ø§Ø¨Ø· ---
    async function addLink() {
        const url = document.getElementById('mediaUrl').value;
        const duration = document.getElementById('duration').value;
        if(!url) return alert("Ø¶Ø¹ Ø§Ù„Ø±Ø§Ø¨Ø·!");

        const type = (url.includes('.mp4') || url.includes('video')) ? 'video' : 'image';
        await insertToDB(url, type, duration);
        alert("âœ… ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„!");
        document.getElementById('mediaUrl').value = '';
    }

    // --- 2. Ø±ÙØ¹ Ù…Ù„Ù ---
    async function uploadFile() {
        const fileInput = document.getElementById('fileInput');
        const file = fileInput.files[0];
        const status = document.getElementById('uploadStatus');
        
        if (!file) return alert("Ø§Ø®ØªØ± Ù…Ù„ÙØ§Ù‹!");

        status.style.display = 'block';
        status.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹... â˜ï¸";

        try {
            const fileName = Date.now() + '_' + file.name.replace(/[^a-zA-Z0-9.]/g, '');
            const { error } = await supabase.storage.from('uploads').upload(fileName, file);
            if(error) throw error;

            const { data } = supabase.storage.from('uploads').getPublicUrl(fileName);
            const type = file.type.startsWith('video') ? 'video' : 'image';
            
            await insertToDB(data.publicUrl, type, 5000);
            status.innerText = "âœ… ØªÙ… Ø§Ù„Ø±ÙØ¹ ÙˆØ§Ù„Ø¥Ø±Ø³Ø§Ù„!";
        } catch(err) {
            alert("ÙØ´Ù„ Ø§Ù„Ø±ÙØ¹: " + err.message);
            status.innerText = "";
        }
    }

    // --- Ù…Ø³Ø§Ø¹Ø¯: Ø§Ù„Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ ---
    async function insertToDB(url, type, duration) {
        await supabase.from('playlist').insert([{ media_url: url, media_type: type, duration: parseInt(duration) }]);
    }

    // --- 3. Ø§Ù„Ø­Ø°Ù ---
    async function deleteItem(id) {
        if(confirm("Ø­Ø°ÙØŸ")) await supabase.from('playlist').delete().eq('id', id);
    }

    // --- 4. Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¨Ø§Ø´Ø± (Realtime) ---
    function render(data) {
        const tbody = document.getElementById('playlistTable');
        const empty = document.getElementById('emptyMsg');
        tbody.innerHTML = '';
        
        if(data && data.length > 0) {
            empty.style.display = 'none';
            data.forEach(item => {
                const isVideo = item.media_type === 'video';
                tbody.innerHTML += `
                <tr>
                    <td>${isVideo ? 'ğŸ¬' : `<img src="${item.media_url}" class="preview-img">`}</td>
                    <td>${item.media_type}</td>
                    <td>${item.duration}</td>
                    <td><button onclick="deleteItem(${item.id})" class="btn btn-sm btn-outline-danger">Ø­Ø°Ù ğŸ—‘ï¸</button></td>
                </tr>`;
            });
        } else {
            empty.style.display = 'block';
            empty.innerText = "Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙØ§Ø±ØºØ©";
        }
    }

    // Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙÙŠ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
    supabase.channel('any').on('postgres_changes', { event: '*', schema: 'public', table: 'playlist' }, () => fetchData()).subscribe();

    async function fetchData() {
        const { data } = await supabase.from('playlist').select('*').order('id', { ascending: false });
        render(data);
    }
    fetchData();

</script>
</body>
</html>