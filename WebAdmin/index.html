<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø´Ø§Ø´Ø§Øª Ø³Ø¨Ø£ (SabaPost)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f0f2f5; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .main-card { max-width: 1100px; margin: 40px auto; box-shadow: 0 4px 20px rgba(0,0,0,0.1); border: none; border-radius: 20px; overflow: hidden; }
        .header { background: linear-gradient(135deg, #880e4f, #ad1457); color: white; padding: 30px; text-align: center; }
        .nav-tabs .nav-link { color: #880e4f; font-weight: bold; }
        .nav-tabs .nav-link.active { color: #000; border-bottom: 3px solid #880e4f; }
        .btn-primary-custom { background-color: #880e4f; color: white; border: none; padding: 10px 20px; border-radius: 10px; }
        .preview-img { width: 80px; height: 50px; object-fit: cover; border-radius: 8px; border: 1px solid #ddd; }
        .vercel-link { color: #000 !important; background-color: #f8f9fa; margin-right: 5px; border: 1px solid #dee2e6; border-bottom: none; }
        .screen-row-pending { background-color: #fff3cd !important; }
    </style>
</head>
<body>

<div class="card main-card">
    <div class="header">
        <h1>ğŸ–¥ï¸ Ù†Ø¸Ø§Ù… Ø´Ø§Ø´Ø§Øª Ø³Ø¨Ø£</h1>
        <p class="mb-0">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø±ÙƒØ²ÙŠØ© - SabaPost</p>
    </div>
    
    <div class="card-body p-4">
        
        <ul class="nav nav-tabs mb-4" id="myTab" role="tablist">
            <li class="nav-item"><button class="nav-link active" id="screens-tab" data-bs-toggle="tab" data-bs-target="#screens-pane">ğŸ“º Ø§Ù„Ø´Ø§Ø´Ø§Øª</button></li>
            <li class="nav-item"><button class="nav-link" id="upload-tab" data-bs-toggle="tab" data-bs-target="#upload-pane">ğŸ“¤ Ø±ÙØ¹ Ù…Ù„Ù</button></li>
            <li class="nav-item"><button class="nav-link" id="link-tab" data-bs-toggle="tab" data-bs-target="#link-pane">ğŸ”— Ø±Ø§Ø¨Ø· Ø®Ø§Ø±Ø¬ÙŠ</button></li>
            <li class="nav-item ms-auto"> <a class="nav-link vercel-link" href="https://vercel.com/bashars-projects-d55b853e/~/stores/blob/store_vVFrsAUHJGVb8cWq/browser" target="_blank">ğŸ—‚ï¸ Ù…Ù„ÙØ§Øª Vercel â†—</a></li>
        </ul>

        <div class="tab-content mb-5" id="myTabContent">
            
            <div class="tab-pane fade show active" id="screens-pane">
                <h5 class="mb-3 text-secondary">Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…ØªØµÙ„Ø©</h5>
                <div class="table-responsive">
                    <table class="table table-bordered align-middle text-center">
                        <thead class="table-light"><tr><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th style="width: 30%;">Ø§Ø³Ù… Ø§Ù„Ø¬Ù‡Ø§Ø²</th><th>IP Address</th><th>ÙƒÙˆØ¯ Ø§Ù„Ø¬Ù‡Ø§Ø² (ID)</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead>
                        <tbody id="screensTable"></tbody>
                    </table>
                    <div id="loadingScreens" class="text-center text-muted">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...</div>
                </div>
            </div>

            <div class="tab-pane fade" id="upload-pane">
                <div class="row g-3 align-items-end">
                    <div class="col-md-12 mb-2">
                        <label class="form-label fw-bold text-danger">Ø¹Ø±Ø¶ ÙÙŠ:</label>
                        <select id="targetScreenUpload" class="form-select border-danger">
                            <option value="all">ğŸŒ ÙƒÙ„ Ø§Ù„Ø´Ø§Ø´Ø§Øª (Ø§ÙØªØ±Ø§Ø¶ÙŠ)</option>
                        </select>
                    </div>
                    <div class="col-md-7">
                        <label class="form-label">Ø§Ø®ØªØ± Ø§Ù„Ù…Ù„Ù:</label>
                        <input type="file" id="fileInput" class="form-control" accept="image/*,video/*">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Ø§Ù„Ù…Ø¯Ø© (ms):</label>
                        <input type="number" id="durationUpload" class="form-control" value="5000">
                    </div>
                    <div class="col-md-2">
                        <button onclick="uploadFile()" class="btn btn-primary-custom w-100" id="btnUpload">Ø±ÙØ¹ ğŸš€</button>
                    </div>
                </div>
                <div class="progress mt-3" id="progressContainer" style="display: none; height: 20px;">
                    <div id="progressBar" class="progress-bar bg-success" style="width: 0%">0%</div>
                </div>
            </div>

            <div class="tab-pane fade" id="link-pane">
                <div class="row g-3 align-items-end">
                    <div class="col-md-12 mb-2">
                        <label class="form-label fw-bold text-danger">Ø¹Ø±Ø¶ ÙÙŠ:</label>
                        <select id="targetScreenLink" class="form-select border-danger">
                            <option value="all">ğŸŒ ÙƒÙ„ Ø§Ù„Ø´Ø§Ø´Ø§Øª (Ø§ÙØªØ±Ø§Ø¶ÙŠ)</option>
                        </select>
                    </div>
                    <div class="col-md-7">
                        <label class="form-label">Ø§Ù„Ø±Ø§Ø¨Ø·:</label>
                        <input type="text" id="urlInput" class="form-control" placeholder="https://example.com/image.jpg">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Ø§Ù„Ù…Ø¯Ø© (ms):</label>
                        <input type="number" id="durationLink" class="form-control" value="5000">
                    </div>
                    <div class="col-md-2">
                        <button onclick="addLink()" class="btn btn-primary-custom w-100">Ø¥Ø¶Ø§ÙØ© ğŸ’¾</button>
                    </div>
                </div>
            </div>
        </div>

        <hr>

        <h5 class="mb-3 text-secondary">ğŸ“‹ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ù†Ø´Ø·Ø©</h5>
        <div class="table-responsive">
            <table class="table table-hover align-middle">
                <thead class="table-light">
                    <tr>
                        <th>Ø§Ù„Ù…Ø­ØªÙˆÙ‰</th>
                        <th>Ø§Ù„Ù†ÙˆØ¹</th>
                        <th>Ø§Ù„Ù…Ø¯Ø©</th>
                        <th>Ù…ÙˆØ¬Ù‡ Ø¥Ù„Ù‰ ğŸ¯</th> <th>ØªØ­ÙƒÙ…</th>
                    </tr>
                </thead>
                <tbody id="playlistTable"></tbody>
            </table>
            <div id="loadingMsg" class="text-center text-muted py-3">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...</div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
  import { getDatabase, ref, push, set, onValue, remove, update } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";
  import { getStorage, ref as sRef, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCNIsI9vB3sVlXaAScG_U0qcqMBcodqOBI",
    authDomain: "sabapost-c26e3.firebaseapp.com",
    databaseURL: "https://sabapost-c26e3-default-rtdb.firebaseio.com",
    projectId: "sabapost-c26e3",
    storageBucket: "saba-dashboard-f67g-blob", 
    messagingSenderId: "516209922306",
    appId: "1:516209922306:web:dc4f732a642267d872321b",
    measurementId: "G-ZYFDG7N05G"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const storage = getStorage(app);
  
  const playlistRef = ref(db, 'playlist');
  const screensRef = ref(db, 'screens');

  // Ù…ØªØºÙŠØ± Ù„ØªØ®Ø²ÙŠÙ† Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø´Ø§Ø´Ø§Øª Ù„Ù„Ø±Ø¬ÙˆØ¹ Ø¥Ù„ÙŠÙ‡Ø§
  let screenNamesMap = {};

  // ==========================================
  // Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø´Ø§Ø´Ø§Øª ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø©
  // ==========================================
  
  onValue(screensRef, (snapshot) => {
      const screensTable = document.getElementById('screensTable');
      const selectUpload = document.getElementById('targetScreenUpload');
      const selectLink = document.getElementById('targetScreenLink');
      
      document.getElementById('loadingScreens').style.display = 'none';
      screensTable.innerHTML = "";
      
      // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø©
      selectUpload.innerHTML = '<option value="all">ğŸŒ ÙƒÙ„ Ø§Ù„Ø´Ø§Ø´Ø§Øª (Ø§ÙØªØ±Ø§Ø¶ÙŠ)</option>';
      selectLink.innerHTML = '<option value="all">ğŸŒ ÙƒÙ„ Ø§Ù„Ø´Ø§Ø´Ø§Øª (Ø§ÙØªØ±Ø§Ø¶ÙŠ)</option>';
      screenNamesMap = {};

      if (snapshot.exists()) {
          snapshot.forEach((childSnapshot) => {
              const id = childSnapshot.key;
              const data = childSnapshot.val();
              const isPending = data.status === 'pending';
              const screenName = data.name || 'Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…';
              
              // ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø§Ø³Ù… Ù„Ù„Ø®Ø±ÙŠØ·Ø©
              screenNamesMap[id] = screenName;

              // ØªØ­Ø¯ÙŠØ« Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø´Ø§Ø´Ø§Øª
              let statusBadge = isPending ? '<span class="badge bg-warning text-dark">â³ Ø§Ù†ØªØ¸Ø§Ø±</span>' : '<span class="badge bg-success">âœ… Ù…ØªØµÙ„</span>';
              let rowClass = isPending ? 'screen-row-pending' : '';
              let actionBtn = isPending
                  ? `<button onclick="approveScreen('${id}')" class="btn btn-sm btn-success">ØªÙØ¹ÙŠÙ„</button>`
                  : `<button onclick="deleteScreen('${id}')" class="btn btn-sm btn-outline-danger">ÙØµÙ„</button>`;

              screensTable.innerHTML += `
                <tr class="${rowClass}">
                    <td>${statusBadge}</td>
                    <td>
                        <div class="input-group input-group-sm" style="max-width: 250px; margin: 0 auto;">
                            <input type="text" id="name-${id}" class="form-control" value="${screenName}" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø´Ø§Ø´Ø©">
                            <button class="btn btn-outline-primary" onclick="updateScreenName('${id}')">ğŸ’¾</button>
                        </div>
                    </td>
                    <td dir="ltr">${data.ip || '---'}</td>
                    <td><small class="text-muted">${id}</small></td>
                    <td>${actionBtn} ${isPending ? `<button onclick="deleteScreen('${id}')" class="btn btn-sm btn-outline-danger ms-1">Ø±ÙØ¶</button>` : ''}</td>
                </tr>
              `;

              // ØªØ­Ø¯ÙŠØ« Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± (ÙÙ‚Ø· Ù„Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„Ù…ÙØ¹Ù„Ø©)
              if (!isPending) {
                  const optionText = `ğŸ“º ${screenName}`;
                  selectUpload.innerHTML += `<option value="${id}">${optionText}</option>`;
                  selectLink.innerHTML += `<option value="${id}">${optionText}</option>`;
              }
          });
      } else {
          document.getElementById('loadingScreens').style.display = 'block';
          document.getElementById('loadingScreens').innerText = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø´Ø§Ø´Ø§Øª Ù…ØªØµÙ„Ø© Ø­Ø§Ù„ÙŠØ§Ù‹";
      }
  });

  window.approveScreen = (id) => update(ref(db, 'screens/' + id), { status: 'linked' });
  window.deleteScreen = (id) => { if(confirm("ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°ÙØŸ")) remove(ref(db, 'screens/' + id)); };
  window.updateScreenName = (id) => {
      const newName = document.getElementById(`name-${id}`).value;
      if (newName.trim() !== "") update(ref(db, 'screens/' + id), { name: newName });
  };

  // ==========================================
  // Ø§Ù„Ø±ÙØ¹ ÙˆØ§Ù„Ø¥Ø¶Ø§ÙØ© (Ù…Ø¹ Ø¯Ø¹Ù… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø´Ø§Ø´Ø©)
  // ==========================================

  window.uploadFile = function() {
      const fileInput = document.getElementById('fileInput');
      const duration = document.getElementById('durationUpload').value;
      const targetScreen = document.getElementById('targetScreenUpload').value; // âœ… Ø§Ù„Ù‡Ø¯Ù
      const file = fileInput.files[0];

      if (!file) { alert("âš ï¸ Ø§Ø®ØªØ± Ù…Ù„ÙØ§Ù‹!"); return; }

      document.getElementById('progressContainer').style.display = 'block';
      document.getElementById('btnUpload').disabled = true;
      document.getElementById('btnUpload').innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹...";

      const storageRef = sRef(storage, 'uploads/' + Date.now() + '_' + file.name);
      const uploadTask = uploadBytesResumable(storageRef, file);

      uploadTask.on('state_changed',
        (snapshot) => {
            const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
        },
        (error) => { alert("âŒ Ø®Ø·Ø£: " + error.message); resetUploadForm(); },
        () => {
            getDownloadURL(uploadTask.snapshot.ref).then((downloadURL) => {
                saveToDatabase(downloadURL, duration, targetScreen); // âœ… ØªÙ…Ø±ÙŠØ± Ø§Ù„Ù‡Ø¯Ù
                resetUploadForm();
                alert("âœ… ØªÙ…!");
            });
        }
      );
  }

  function resetUploadForm() {
      document.getElementById('fileInput').value = '';
      document.getElementById('progressContainer').style.display = 'none';
      document.getElementById('progressBar').style.width = '0%';
      document.getElementById('btnUpload').disabled = false;
      document.getElementById('btnUpload').innerText = "Ø±ÙØ¹ ğŸš€";
  }

  window.addLink = function() {
      const url = document.getElementById('urlInput').value;
      const duration = document.getElementById('durationLink').value;
      const targetScreen = document.getElementById('targetScreenLink').value; // âœ… Ø§Ù„Ù‡Ø¯Ù

      if (!url) { alert("âš ï¸ Ø¶Ø¹ Ø±Ø§Ø¨Ø·Ø§Ù‹!"); return; }
      saveToDatabase(url, duration, targetScreen); // âœ… ØªÙ…Ø±ÙŠØ± Ø§Ù„Ù‡Ø¯Ù
      document.getElementById('urlInput').value = '';
      alert("âœ… ØªÙ…!");
  }

  // âœ… Ø¯Ø§Ù„Ø© Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ù…Ø­Ø¯Ø«Ø©
  function saveToDatabase(url, duration, target) {
      push(playlistRef, { 
          imageUrl: url, 
          duration: parseInt(duration),
          targetScreenId: target // âœ… Ø­ÙØ¸ ÙˆØ¬Ù‡Ø© Ø§Ù„Ø¹Ø±Ø¶
      });
  }

  window.deleteSlide = (key) => { if(confirm("Ø­Ø°ÙØŸ")) remove(ref(db, 'playlist/' + key)); };

  // ==========================================
  // Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªØ´ØºÙŠÙ„
  // ==========================================

  onValue(playlistRef, (snapshot) => {
      const tableBody = document.getElementById('playlistTable');
      const loadingMsg = document.getElementById('loadingMsg');
      tableBody.innerHTML = "";

      if (snapshot.exists()) {
          loadingMsg.style.display = "none";
          snapshot.forEach((childSnapshot) => {
              const key = childSnapshot.key;
              const data = childSnapshot.val();
              const isVideo = data.imageUrl.includes(".mp4") || data.imageUrl.includes("video");
              
              // âœ… ØªØ­Ø¯ÙŠØ¯ Ø§Ø³Ù… Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ©
              let targetName = "ğŸŒ Ø§Ù„ÙƒÙ„";
              if (data.targetScreenId && data.targetScreenId !== 'all') {
                  // Ø¬Ù„Ø¨ Ø§Ù„Ø§Ø³Ù… Ù…Ù† Ø§Ù„Ø®Ø±ÙŠØ·Ø©ØŒ Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙƒÙˆØ¯ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙˆØ¬Ø¯ Ø§Ø³Ù…
                  targetName = `ğŸ“º ${screenNamesMap[data.targetScreenId] || 'Ø´Ø§Ø´Ø© Ù…Ø­Ø°ÙˆÙØ©'}`;
              }

              const row = `
                <tr>
                    <td>${isVideo ? '<span class="badge bg-dark">ğŸ¥ ÙÙŠØ¯ÙŠÙˆ</span>' : `<a href="${data.imageUrl}" target="_blank"><img src="${data.imageUrl}" class="preview-img"></a>`}</td>
                    <td>${isVideo ? 'ÙÙŠØ¯ÙŠÙˆ' : 'ØµÙˆØ±Ø©'}</td>
                    <td>${data.duration} ms</td>
                    <td><span class="badge ${data.targetScreenId !== 'all' ? 'bg-info text-dark' : 'bg-secondary'}">${targetName}</span></td>
                    <td><button onclick="deleteSlide('${key}')" class="btn btn-sm btn-outline-danger">Ø­Ø°Ù ğŸ—‘ï¸</button></td>
                </tr>
              `;
              tableBody.innerHTML += row;
          });
      } else {
          loadingMsg.innerText = "Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙØ§Ø±ØºØ©";
          loadingMsg.style.display = "block";
      }
  });
</script>

</body>
</html>